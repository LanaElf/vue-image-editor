<template>
    <div class="editor">
    <!-- Бонус -->
        <div v-show="annotationObjects.length" class="annotations-container">
           <button 
                class="btn annotations-btn" 
                @click="openAnnotations = !openAnnotations" 
                :disabled="!hasImage">
                {{openAnnotations ? 'Скрыть' : 'Показать'}} JSON
            </button>

            <div v-show="openAnnotations" class="annotations-json">
                <pre>{{ annotationObjects }}</pre>
            </div> 
        </div>

        <div style="height: 80vh">
          <PinturaEditor
              v-bind="editorProps"
              :src="props.imageSrc"
              @pintura:process="onEditorProcess"
              @pintura:update="onEditorUpdate"
          />
        </div>
    </div>

    <ConfirmExportModal
        v-model:showModal="showModal"
        v-model:previewUrl="previewUrl"
        v-model:pendingBlob="pendingBlob"
    />
</template>

<script setup lang="ts">
import '@pqina/pintura/pintura.css'
import { PinturaEditor } from '@pqina/vue-pintura'

const props = defineProps<{ imageSrc: string | null; }>()

const { $pinturaDefaults } = useNuxtApp()

const editorProps = $pinturaDefaults
const annotationObjects = ref<any[]>([])
const openAnnotations = ref(false)
const hasImage = computed(() => !!props.imageSrc)

const showModal = ref(false)
const previewUrl = ref('')
const pendingBlob = ref<Blob | null>(null)

const onEditorUpdate = (e: any) => {
  const state = e.detail
  annotationObjects.value = (state && state.annotation) || []
}

const onEditorProcess = async (data: any) => {
  try {
    const blob: Blob = data.detail.dest
    
    const finalBlob = blob.type !== 'image/png' 
      ? new Blob([await blob.arrayBuffer()], { type: 'image/png' })
      : blob
    
    previewUrl.value = URL.createObjectURL(finalBlob)
    pendingBlob.value = finalBlob
    showModal.value = true
    
  } catch (err) {
    console.error('Ошибка при экспорте изображения: ', err)
  }
}
</script>

<style>
.editor {
    position: relative;
}
.annotations-container {
    position: absolute;
    z-index: 1;
    left: 16px;
    top: 60px;
}

.annotations-json {
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: space-between;
}

.annotations-json pre{
    border: 1px solid var(--secondary-color);
    color: var(--primary-color);
    border-radius: 6px;
    padding: 8px;
    background: #0f0420;
    font-size: 12px;
    max-height: 54vh;
    width: 280px;
    overflow: auto;
    box-sizing: border-box;
    margin: 0;
    margin-top: 1em;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) var(--secondary-color) ;
}

.editor .PinturaRoot .PinturaButtonExport {
  background-color: var(--primary-color) !important;
  transition: 0.4s;
  color: #fff;
  font-weight: 600;
}

.editor .PinturaRoot .PinturaButtonExport:hover:not(:disabled) {
  background-color: var(--secondary-color) !important;
}
</style>